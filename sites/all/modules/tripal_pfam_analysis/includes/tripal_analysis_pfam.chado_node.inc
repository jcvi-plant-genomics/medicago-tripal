<?php 

/*******************************************************************************
 *  Provide information to drupal about the node types that we're creating
*  in this module
*/
function tripal_analysis_pfam_node_info() {
  $nodes = array();
  $nodes['chado_analysis_pfam'] = array(
    'name' => t('Analysis: Pfam'),
    'base' => 'chado_analysis_pfam',
    'description' => t('An pfam analysis from the chado database'),
    'has_title' => FALSE,
    'title_label' => t('Analysis: Pfam'),
    'has_body' => FALSE,
    'body_label' => t('Pfam Analysis Description'),
    'locked' => TRUE,
    'chado_node_api' => array(
      'base_table' => 'analysis',
      'hook_prefix' => 'chado_analysis_pfam',
      'record_type_title' => array(
        'singular' => t('Pfam Analysis'),
        'plural' => t('Pfam Analyses')
      ),
      // this module will not sync.  that will be handled by the
      // analysis module
    )
  );
  return $nodes;
}

/*******************************************************************************
 *  The following function proves access control for users trying to
*  perform actions on data managed by this module
*/
function chado_analysis_pfam_access($op, $node, $account) {
  if ($op == 'create') {
    if (!user_access('create chado_analysis_pfam content', $account)) {
      return FALSE;
    }
  }
  if ($op == 'update') {
    if (!user_access('edit chado_analysis_pfam content', $account)) {
      return FALSE;
    }
  }
  if ($op == 'delete') {
    if (!user_access('delete chado_analysis_pfam content', $account)) {
      return FALSE;
    }
  }
  if ($op == 'view') {
    if (!user_access('access chado_analysis_pfam content', $account)) {
      return FALSE;
    }
  }
  return NULL;
}

/*******************************************************************************
 *  Provide a Pfam Analysis form
*/
function chado_analysis_pfam_form($node, $form_state) {

  // add in the default fields for the analysis
  $form = chado_analysis_form($node, $form_state);
  // set the fedaults
  $pfamprofile = '';
  $pfamjob = '';
  $parsepfam = '';
  $pfamparameters = '';
  $query_re = '';
  $query_type = '';
  $query_uniquename = '';
  
  if (property_exists ( $node, 'analysis' )) {
    $analysis = $node->analysis;
    $pfamprofile = $analysis->tripal_analysis_pfam->pfamprofile;
    $pfamparameters = $analysis->tripal_analysis_pfam->pfamparameters;
    $parsepfam = $analysis->tripal_analysis_pfam->parsepfam;
    $query_re = $analysis->tripal_analysis_pfam->query_re;
    $query_type = $analysis->tripal_analysis_pfam->query_type;
    $query_uniquename = $analysis->tripal_analysis_pfam->query_uniquename;
  }

  $moreSettings ['pfam'] = 'Pfam Settings';
  $form['pfam'] = array(
      '#title' => t('Pfam Settings'),
      '#type' => 'fieldset',
      '#description' => t('Specific Settings for Pfam Analysis.'),
      '#collapsible' => TRUE,
      '#attributes' => array('id' => 'pfam-extra-settings'),
      '#weight' => 11
  );
  $form['pfam']['pfamprofile'] = array(
      '#title' => t('PfamScan XML File/Directory: (if you input a directory without the tailing slash, all xml files in the directory will be loaded)'),
      '#type' => 'textfield',
      '#description' => t('Please provide the full path to the XML output file generated by PfamScan or a directory containing multiple XML files.'),
      '#default_value' => $pfamprofile,
  );
  $form['pfam']['pfamjob'] = array(
      '#type' => 'checkbox',
      '#title' => t('Submit a job to parse the PfamScan XML file(s)'),
      '#description' => t('Note: features associated with the pfam results must '.
          'exist in chado before parsing the file. Otherwise, pfam '.
          'results that cannot be linked to a feature will not '.
          'be imported.  The feature name must be unique'),
      '#default_value' => $pfamjob,
      '#attributes' => array(
          'onclick' => 'return isSubmittingJob(this)'
      )
  );
  $form['pfam']['parsepfam'] = array(
      '#type' => 'checkbox',
      '#title' => t('Load PFAM terms to the database'),
      '#description' => t('Check the box to load PFAM terms to chado database'),
      '#default_value' => $parsepfam
  );
  $form['pfam']['pfamparameters'] = array(
      '#title' => t('Parameters'),
      '#type' => 'textfield',
      '#description' => t('The parameters used when running the PfamScan analysis.'),
      '#default_value' => $pfamparameters,
  );

  $form['pfam']['query_re'] = array(
      '#title' => t('Query Name RE'),
      '#type' => 'textfield',
      '#description' => t('Enter the regular expression that will extract the '.
          'feature name from the query line in the pfam results. This option '.
          'is only required when the query does not identically match a feature '.
          'in the database. For example: ^.*id=(.*?).*$'),
      '#default_value' => $query_re,
  );

  $form['pfam']['query_uniquename'] = array(
      '#title' => t('Use Unique Name'),
      '#type' => 'checkbox',
      '#description' => t('Select this checkbox if the query name in the results file matches the unique name of the feature. '),
      '#default_value' => $query_uniquename,
  );

  $form['pfam']['query_type'] = array(
      '#title' => t('Query Type'),
      '#type' => 'textfield',
      '#description' => t('Please enter the Sequence Ontology term (e.g. contig, polypeptide, mRNA) that describes '.
          'the query sequences in the PfamScan XML results file(s).  This is only necessary if two '.
          'or more sequences have the same name.'),
      '#default_value' => $query_type,
  );
  return $form;
}
/**
 *
 */
function chado_analysis_pfam_validate($node, &$form, &$form_state) {
  
  // use the analysis parent to validate the node
  tripal_analysis_validate($node, $form, $form_state);
  
  // trim character fields
  $node->pfamprofile      = trim($node->pfamprofile);
  $node->query_uniquename  = trim($node->query_uniquename);
  $node->query_type        = trim($node->query_type);
  $node->query_re          = trim($node->query_re);
  
  
  // check the regular expression to make sure it is valid
  $result = 0;
  $code = "\$result = preg_match(\"test\", \"/" . $node->query_re . "/\")";
  eval($code);
  if ($result === FALSE) {
    form_set_error('query_re', 'Invalid regular expression.');
  }
  
  if($node->pfamprofile and !is_readable($node->pfamprofile)) {
    form_set_error('pfamprofile', "Can not read Pfam XML output file: '$node->pfamprofile'. Please check file permissions or typos in the file path.");
  }
  
}
/**
 *
 *
 */
function chado_analysis_pfam_load($nodes) {

  // load the default set of analysis fields
  chado_analysis_load($nodes);

  foreach ($nodes as $nid => $node) {
    // create some variables for easier lookup
    $analysis = $node->analysis;
    $analysis_id = $analysis->analysis_id;

    $pfam_settings  = tripal_analysis_get_property($analysis->analysis_id, 'analysis_pfam_settings');
    $pfamprofile      = tripal_analysis_get_property($analysis->analysis_id, 'analysis_pfam_pfamprofile');
    $pfamparameters= tripal_analysis_get_property($analysis->analysis_id, 'analysis_pfam_pfamparameters');
    $parsepfam           = tripal_analysis_get_property($analysis->analysis_id, 'analysis_pfam_parsepfam');
    $query_re          = tripal_analysis_get_property($analysis->analysis_id, 'analysis_pfam_query_re');
    $query_type        = tripal_analysis_get_property($analysis->analysis_id, 'analysis_pfam_query_type');
    $query_uniquename  = tripal_analysis_get_property($analysis->analysis_id, 'analysis_pfam_query_uniquename');

    $analysis->tripal_analysis_pfam = new stdClass;
    $analysis->tripal_analysis_pfam->pfamprofile      = $pfamprofile->value;
    $analysis->tripal_analysis_pfam->pfamparameters= $pfamparameters->value;
    //$analysis->tripal_analysis_pfam->parsepfam           = $parsepfam->value;
    $analysis->tripal_analysis_pfam->query_re          = $query_re->value;
    $analysis->tripal_analysis_pfam->query_type        = $query_type->value;
    $analysis->tripal_analysis_pfam->query_uniquename  = $query_uniquename->value;

    // if there is an old style 'pfam_settings' array, then break these out for
    // use in the new format
    if (count($pfam_settings)>0) {
      $prop_values = explode("|", $pfam_settings->value);
      $analysis->tripal_analysis_pfam->pfamprofile       = $prop_values[0];
      $analysis->tripal_analysis_pfam->pfamparameters = $prop_values[1];
    }
    
    // Now get the title
    //$node->title = chado_get_node_title($node);
    $node->title=$analysis->name;
    $nodes[$nid]->analysis = $analysis;
  }
}
/**
 *
 */
function chado_analysis_pfam_insert($node) {
  
  // insert the analysis. If the analysis already exist then this
  // call will link it to a new Drupa node.
  chado_analysis_insert($node);

  // trim character fields
  $node->pfamprofile      = trim($node->pfamprofile);
  $node->query_uniquename  = trim($node->query_uniquename);
  $node->query_type        = trim($node->query_type);
  
  // set the type for this analysis
  tripal_analysis_insert_property($node->analysis_id, 'analysis_type', 'tripal_analysis_pfam');

  // now add in the remaining settings as a single property but separated by bars
  tripal_analysis_insert_property($node->analysis_id, 'analysis_pfam_pfamprofile', trim($node->pfamprofile));
  tripal_analysis_insert_property($node->analysis_id, 'analysis_pfam_pfamparameters', trim($node->pfamparameters));
  tripal_analysis_insert_property($node->analysis_id, 'analysis_pfam_parsepfam', trim($node->parsepfam));
  tripal_analysis_insert_property($node->analysis_id, 'analysis_pfam_query_re', trim($node->query_re));
  tripal_analysis_insert_property($node->analysis_id, 'analysis_pfam_query_type', trim($node->query_type));
  tripal_analysis_insert_property($node->analysis_id, 'analysis_pfam_query_uniquename', trim($node->query_uniquename));

  // submit the parsing jobs
  chado_analysis_pfam_submit_job($node);
}

/**
  *
  */
function chado_analysis_pfam_update($node) {

  // insert the analysistripal_core_generate_chado_var
  chado_analysis_update($node);

  // trim character fields
  $node->pfamprofile      = trim($node->pfamprofile);
  $node->query_uniquename  = trim($node->query_uniquename);
  $node->query_type        = trim($node->query_type);
  
  // set the type for this analysis
  tripal_analysis_update_property($node->analysis_id, 'analysis_type', 'tripal_analysis_pfam', 1);

  // now add in the remaining settings as a single property but separated by bars
  tripal_analysis_update_property($node->analysis_id, 'analysis_pfam_pfamprofile', trim($node->pfamprofile), 1);
  tripal_analysis_update_property($node->analysis_id, 'analysis_pfam_pfamparameters', trim($node->pfamparameters), 1);
  tripal_analysis_update_property($node->analysis_id, 'analysis_pfam_parsepfam', trim($node->parsepfam), 1);
  tripal_analysis_update_property($node->analysis_id, 'analysis_pfam_query_re', trim($node->query_re), 1);
  tripal_analysis_update_property($node->analysis_id, 'analysis_pfam_query_type', trim($node->query_type), 1);
  tripal_analysis_update_property($node->analysis_id, 'analysis_pfam_query_uniquename', trim($node->query_uniquename), 1);

  // if this analysis uses the old style settings cvterm then remove that term
  $old = tripal_analysis_get_property($node->analysis_id, 'analysis_pfam_settings');
  if (count($old) > 0) {
    tripal_analysis_delete_property($node->analysis_id, 'analysis_pfam_settings');
  }

  // submit the parsing jobs
  chado_analysis_pfam_submit_job($node);
}

/**
 * Delete pfam anlysis
 */
function chado_analysis_pfam_delete($node) {
  chado_analysis_delete($node);
}

/**
 *
 */
function chado_analysis_pfam_submit_job($node) {
  global $user;

  // Add a job if the user wants to parse the xml output
  if ($node->pfamjob) {
    $job_args[0] = $node->analysis_id;
    $job_args[1] = $node->pfamprofile;
    if ($node->parsepfam) {
      $job_args[2] = 1;
    }
    else {
      $job_args[2] = 0;
    }

    $fname = preg_replace ( "/.*\/(.*)/", "$1", $node->pfamprofile );
    $job_args [3] = $node->query_re;
    $job_args [4] = $node->query_type;
    $job_args [5] = $node->query_uniquename;
    tripal_add_job("Parse XML pfam: $fname", 'tripal_analysis_pfam', 'tripal_analysis_pfam_parseXMLFile', $job_args, $user->uid);
  }
}

/**
 * *****************************************************************************
 * This function customizes the view of the chado_analysis node.
 * It allows
 * us to generate the markup.
 */
function chado_analysis_pfam_view($node, $teaser = FALSE, $page = FALSE) {
  // use drupal's default node view:
  if (! $teaser) {
    $node = node_prepare ( $node, $teaser );
    // When previewing a node submitting form, it shows 'Array' instead of
    // correct date format. We need to format the date here
    $time = $node->timeexecuted;
    if (is_array ( $time )) {
      $month = $time ['month'];
      $day = $time ['day'];
      $year = $time ['year'];
      $timestamp = $year . '-' . $month . '-' . $day;
      $node->timeexecuted = $timestamp;
    }
    // When viewing a node, we need to reformat the analysisprop since we
    // separate each value with a bar |
    if (preg_match ( "/.*\|.*/", $node->pfamprofile )) {
      $prop_values = explode ( "|", $node->pfamprofile );
      $node->pfamprofile = $prop_values [0];
      $node->pfamparameters = $prop_values [1];
    }
  }
  return $node;
}

/*******************************************************************************
 * tripal_analysis_pfam_nodeapi()
* HOOK: Implementation of hook_nodeapi()
* Display pfam results for allowed node types
*/
function tripal_analysis_pfam_node_view($node, $view_mode, $langcode) {
  switch ($node->type) {
    case 'chado_analysis_pfam':
      if ($view_mode == 'full') {
        $node->content['tripal_analysis_pfam_base'] = array(
            '#markup' => theme('tripal_analysis_pfam_base', array('node' => $node)),
            '#tripal_toc_id'    => 'base',
            '#tripal_toc_title' => 'Overview',
            '#weight' => -100,
        );
      }
      if ($view_mode == 'teaser') {
        $node->content['tripal_analysis_pfam_teaser'] = array(
            '#markup' => theme('tripal_analysis_pfam_teaser', array('node' => $node)),
        );
      }
      break;
    case 'chado_feature':
      if ($view_mode == 'full') {
        $node->content['tripal_feature_pfam_results'] = array(
          '#markup' => theme('tripal_feature_pfam_results', array('node' => $node)),
          '#tripal_toc_id'    => 'pfam',
          '#tripal_toc_title' => 'PFam',
        );
      }
      break;
  }
}


/**
 * Implements [content_type]_chado_node_default_title_format().
 *
 * Defines a default title format for the Chado Node API to set the titles on
 * Chado Analysis nodes based on chado fields.
 */
function chado_analysis_pfam_chado_node_default_title_format() {
  return '[analysis.name]';
}

/**
 * Implements hook_node_insert().
 * Acts on all content types.
 *
 * @ingroup tripal_analysis_pfam
 */
function tripal_analysis_pfam_node_insert($node) {

  switch ($node->type) {
  	case 'chado_analysis_pfam':

  	  // build the analysis variable
  	  $analysis_id = chado_get_id_from_nid('analysis', $node->nid);
  	  $values = array('analysis_id' => $analysis_id);
  	  $analysis = chado_generate_var('analysis', $values);
  	  $node->analysis = $analysis;

  	  // Now get the title
  	  $node->title = chado_get_node_title($node);

  	  break;
  }
}

/**
 * Implements hook_node_update().
 * Acts on all content types.
 *
 * @ingroup tripal_analysis_pfam
 */
function tripal_analysis_pfam_node_update($node) {

  switch ($node->type) {
  	case 'chado_analysis_pfam':

  	  // build the analysis variable
  	  $analysis_id = chado_get_id_from_nid('analysis', $node->nid);
  	  $values = array('analysis_id' => $analysis_id);
  	  $analysis = chado_generate_var('analysis', $values);
  	  $node->analysis = $analysis;

  	  // Now get the title
  	  $node->title = chado_get_node_title($node);

  	  break;
  }
}